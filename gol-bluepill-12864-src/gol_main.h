/*
 * This file is part of gol-bluepill-12864.
 *
 * gol-bluepill-12864 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * gol-bluepill-12864 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with gol-bluepill-12864.  If not, see <https://www.gnu.org/licenses/>.
 */

#pragma once

#include <libopencm3/cm3/nvic.h>
#include <libopencm3/stm32/exti.h>
#include <libopencm3/stm32/gpio.h>
#include <libopencm3/stm32/rcc.h>
#include <libopencm3/stm32/spi.h>
#include <libopencm3/stm32/timer.h>

#include <string.h>

#include "st7920_helper.h"

#define INITIAL_PLAY_RATE_MS 200
#define MIN_PLAY_RATE_MS 150
#define MAX_PLAY_RATE_MS 5000

#define ENCODER_INCREMENT_AMOUNT 100

static void clock_setup(void);
static void gpio_setup(void);
static void spi_setup(void);
static void timer_setup(void);
static void shift_randomn_state(uint8_t num);
static void randomize_state(void);
int main(void);

volatile bool button_pressed = false;
volatile bool play_game = false;
volatile uint16_t encoder_count = INITIAL_PLAY_RATE_MS * 10;

static uint8_t state[SCREEN_WIDTH][SCREEN_HEIGHT] = {0};
static uint8_t future_state[SCREEN_WIDTH][SCREEN_HEIGHT] = {0};

// Random initial state with deterministic future states :(
static uint32_t random_state[SCREEN_HEIGHT * SCREEN_WIDTH / 32] = {
    0x5f624539, 0x5961b2bd, 0x838db14e, 0x174be1ec, 0xe3cade31, 0x4fea509c,
    0x1f00dcc2, 0x544b207f, 0x6a4a35c5, 0xab409a7f, 0xb4768c58, 0xb59d8953,
    0xb4721a6e, 0x7be87c99, 0xca43dd7e, 0x865a12a0, 0x45a20203, 0x53821a06,
    0x693ff995, 0x8d7b4650, 0x4cd1ae3d, 0x163b5ad3, 0xc569adb7, 0x41aa855e,
    0xe325d4e7, 0x5b0b5cec, 0x6e3ccb37, 0x87143905, 0x0271a40d, 0xaed3675f,
    0xc29b25f3, 0x9b323e07, 0x7a232a55, 0x9abcf03c, 0xe2142983, 0xf4e260a7,
    0xadf28475, 0xa4eeb20e, 0x84d1fb03, 0xbfbba552, 0xfb42ec5c, 0xd6d5ad53,
    0xcb7237f5, 0x8a5d9ee6, 0x52e41ba6, 0xb7f2849a, 0x61bdf7ed, 0xef3cc45c,
    0x414adbe6, 0x2b006548, 0x3c5e93a8, 0x857da065, 0xfd6eb47c, 0x8ee2f57a,
    0x1f6a6a4f, 0x3814f7ed, 0x4cc1c875, 0x46570516, 0xb01557d8, 0x58b969d1,
    0xb85a069a, 0xfcf32167, 0xe5318bef, 0x2c54bcaa, 0xa716e8fe, 0xdfb74547,
    0x61b4affc, 0xd44e624a, 0xcd54e266, 0xd4745e71, 0xe9f92e3f, 0xbb9ff5cb,
    0x7ac0c59f, 0x93f1e018, 0x233db307, 0x8bf17206, 0xb54ee66a, 0xc1532063,
    0x705864ee, 0xd0f97fe2, 0x934a006c, 0x971933d7, 0xfb681f8e, 0x4a81d3bc,
    0x8598926a, 0x25b0cab1, 0xb0f3edd7, 0xa32929b0, 0xe2c92296, 0x493b9b35,
    0x40aac888, 0x8d55db50, 0x3adb8da4, 0xcaea6732, 0xd7e45f40, 0x1f485791,
    0x9b480a9e, 0x7b157928, 0xa4ee2435, 0xde5cf732, 0x47973a67, 0x714b3c28,
    0x08ee281c, 0xfd844f78, 0xc078dbe6, 0x20488b5b, 0xd4fd5726, 0x3b77d371,
    0x11376f0f, 0x553870d1, 0x5055f667, 0x3d23b367, 0x9490bb03, 0x48e2df37,
    0xd6e4e5d2, 0xa08b4c95, 0xb9eec566, 0xaf48c4d4, 0xa0339860, 0x1375d1de,
    0xe9df4551, 0xc713a843, 0x27f9a04d, 0x8d513650, 0x4915b22a, 0x91c1c398,
    0xb908bf98, 0xf0ff3dda, 0x79f6d1cc, 0x03ac0c20, 0x8a0df16e, 0x30be65f7,
    0x4aac4e86, 0x37fc5ed0, 0x619b6f1a, 0x12d7006c, 0xdb9fb790, 0xc035d719,
    0xaa41f39e, 0x099cec73, 0x677173fd, 0x4db6da54, 0x8ca667cb, 0x3ffaae87,
    0x87b27840, 0x7f1dcf92, 0x8ec9ae00, 0xbf185ed7, 0x43b63c31, 0x52551990,
    0xc97a34a3, 0xa6186418, 0x8ea41ff0, 0x8484d927, 0x825d7ea9, 0x0bd0f0e7,
    0x552cc133, 0x3f9b239c, 0xe63d2a7b, 0x340792b1, 0x490452bf, 0xbc6fe357,
    0xf560dbda, 0x77c984e8, 0x212f95a8, 0x00a1c3ef, 0x4d96e8a0, 0x279e0d2d,
    0x6bfec471, 0xbe52a6cf, 0x38d03bec, 0xce278af3, 0xaa2afa95, 0x37024db7,
    0xbe637464, 0x454c653e, 0x211b5ea5, 0xc8f144c0, 0xfaa6554e, 0x60c9e67b,
    0xc19deec5, 0xbf23d650, 0x1c152db0, 0x60c0d4ae, 0x209c139c, 0x0827ba63,
    0xe71dcb11, 0xd74f5468, 0x02a9f165, 0xe19f7183, 0x591c0edd, 0xa658c93c,
    0x9554151e, 0x62bce476, 0xd5d86e06, 0x2c725317, 0x68b7e99c, 0x67fd91f8,
    0x0743928d, 0x6f15c5c8, 0xf5703179, 0xe4180831, 0x9d5cfaa4, 0xf9687048,
    0x34d86842, 0x3f58ca81, 0x3e65c3c6, 0x5f158a99, 0xb53d4ba5, 0x19e8ffce,
    0xbb2f2498, 0xb5c0e35c, 0x075e1f2c, 0x10a7c1d0, 0xe5dd0435, 0x1591e383,
    0x38397d90, 0xc3df56f5, 0x1d11925c, 0x45a7d2e5, 0x3980abc5, 0x33111a90,
    0x5cbaec15, 0xf02c1f3b, 0xa3789cac, 0xd7eeb5aa, 0xb6656670, 0x9c8dd19e,
    0x030da386, 0x3e0cb472, 0x3cd99b2c, 0x9426114d, 0x4bf3de2e, 0xebd4c155,
    0x70cd986f, 0x5f29e92b, 0xa9da2882, 0xa78ecd9b, 0x0af8b6de, 0x46c0ffb8,
    0xb8d61bf4, 0x2933687c, 0xd3b35d49, 0x84dbbe5a, 0x7d114966, 0x5fb38453,
    0xdcaf4892, 0x2033939a, 0xc4176eb8, 0xe5c83e75, 0x74290328, 0x05f0ebad,
    0xe27fe0cb, 0xd89a0c74, 0x93870f5a, 0x6ca57e7a};